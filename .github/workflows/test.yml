name: test

on:
  workflow_run:
    workflows: ["build"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (${{ matrix.arch }}, ${{ matrix.static && 'static' || 'dynamic' }}${{ matrix.cuda && ', CUDA' || '' }})
    runs-on: ${{ matrix.runner }}
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            artifact: wprof-amd64-dynamic

          - arch: arm64
            runner: ubuntu-24.04-arm
            artifact: wprof-arm64-dynamic

          - arch: amd64
            runner: ubuntu-latest
            cuda: true
            artifact: wprof-amd64-cuda-dynamic

          - arch: arm64
            runner: ubuntu-24.04-arm
            cuda: true
            artifact: wprof-arm64-cuda-dynamic

          - arch: amd64
            runner: ubuntu-latest
            static: true
            artifact: wprof-amd64-static

          - arch: arm64
            runner: ubuntu-24.04-arm
            static: true
            artifact: wprof-arm64-static

    steps:
      - name: Download wprof binary
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Make binary executable
        run: |
          chmod +x wprof
          ls -lh wprof

      - name: Run sample trace
        run: |
          # Run wprof for 500ms to capture a short trace
          if [ "${{ matrix.cuda }}" = "true" ]; then
            sudo ./wprof -d500 -T trace.pb -D wprof.data -f cuda --log=inject --log=tracees -vv || echo "✗ Failed: wprof trace capture (w/ CUDA) failed"
          else
            sudo ./wprof -d500 -T trace.pb -D wprof.data || echo "✗ Failed: wprof trace capture failed"
          fi
          # Validate binary dump with replay mode
          ./wprof -R -I -D wprof.data | tee /dev/stderr || echo "✗ Failed: wprof.data validation failed"
          if [ "${{ matrix.cuda }}" = "true" ]; then
            ./wprof -R -I -D wprof.data | grep -q "CUDA:.*YES" || echo "✗ Failed: CUDA not detected in trace"
          fi
          # Validate Perfetto trace and count packets
          PACKET_COUNT=$(grep -c 'packet {' trace.pb | wc -l)
          TRACE_SIZE=$(ls -lh trace.pb | awk '{print $5}')
          DATA_SIZE=$(ls -lh wprof.data | awk '{print $5}')
          echo "trace.pb: $TRACE_SIZE, $PACKET_COUNT packets"
          echo "wprof.data: $DATA_SIZE"
          test "$PACKET_COUNT" -gt 1 || echo "✗ Failed: trace.pb has insufficient packets (expected >1, got $PACKET_COUNT)"
          echo "✓ Sample trace completed successfully"

      - name: Run trace with stack traces
        run: |
          # Run wprof with stack traces for 500ms
          sudo ./wprof -d500 -T trace-stacks.pb -D wprof-stacks.data -S || echo "✗ Failed: wprof trace with stacks failed"
          # Validate stack traces were captured
          STACK_OUTPUT=$(./wprof -R -I -D wprof-stacks.data | tee /dev/stderr)
          STACK_COUNT=$(echo "$STACK_OUTPUT" | grep "Stack traces:" | grep -oE '[0-9]+' | head -1)
          echo "Captured $STACK_COUNT stack traces"
          test "$STACK_COUNT" -gt 0 2>/dev/null || echo "✗ Failed: No stack traces captured (got $STACK_COUNT)"
          # Validate file sizes
          TRACE_STACKS_SIZE=$(ls -lh trace-stacks.pb | awk '{print $5}')
          DATA_STACKS_SIZE=$(ls -lh wprof-stacks.data | awk '{print $5}')
          echo "trace-stacks.pb: $TRACE_STACKS_SIZE"
          echo "wprof-stacks.data: $DATA_STACKS_SIZE"
          test -s trace-stacks.pb || echo "✗ Failed: trace-stacks.pb is empty"
          test -s wprof-stacks.data || echo "✗ Failed: wprof-stacks.data is empty"
          echo "✓ Stack trace test completed successfully"

      - name: Upload trace artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traces-${{ matrix.artifact }}
          path: |
            trace.pb
            wprof.data
            trace-stacks.pb
            wprof-stacks.data
          retention-days: 1
